<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Plantafix</title>
  <style>
  :root {
    --green: #39FF14;
    --bg1: #0a0a0a;
    --bg2: #1a1a1a;
    --card-bg: rgba(20,20,20,0.7);
    --text-light: #eee;
    --text-muted: #888;
    --radius: 12px;
    --gap: 16px;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    background: radial-gradient(circle at top left, #111, #000);
    color: var(--text-light);
    font-family: 'M PLUS Code Latin', monospace;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: var(--gap);
  }

  .container {
    width: 100%;
    max-width: 900px;
    background: var(--bg1);
    border-radius: var(--radius);
    padding: calc(var(--gap)*2);
    backdrop-filter: blur(8px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.8);
    animation: fadeIn 0.8s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .header {
    text-align: center;
    margin-bottom: calc(var(--gap)*2);
  }

  .header img {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    filter: drop-shadow(0 0 8px var(--green));
    animation: pulse 2s infinite ease-in-out;
  }

  @keyframes pulse {
    0%,100% { transform: scale(1); }
    50%     { transform: scale(1.1); }
  }

  .header h1 {
    color: var(--green);
    font-size: 2.8rem;
    margin: var(--gap) 0 0.5rem;
  }

  .header p {
    color: var(--text-muted);
    font-size: 0.95rem;
    line-height: 1.4;
    max-width: 600px;
    margin: 0 auto;
  }

  .search-area {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: var(--gap);
    margin-bottom: calc(var(--gap)*2);
  }

  .search-area input {
    padding: 12px 16px;
    background: var(--bg2);
    color: var(--text-light);
    border: 1px solid var(--green);
    border-radius: var(--radius);
    font-size: 1rem;
    outline: none;
    transition: box-shadow .3s;
  }

  .search-area input:focus {
    box-shadow: 0 0 8px var(--green);
  }

  .search-area button {
    padding: 12px 24px;
    background: var(--green);
    color: #000;
    border: none;
    border-radius: var(--radius);
    font-weight: bold;
    cursor: pointer;
    transition: transform .2s, box-shadow .2s;
  }

  .search-area button:hover {
    transform: scale(1.05);
    box-shadow: 0 0 12px var(--green);
  }

  #resultado {
    margin-top: var(--gap);
  }

  .species-block {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    gap: var(--gap);
    margin-top: var(--gap);
  }

  .species-block img {
    width: 180px;
    height: 120px;
    object-fit: cover;
    border-radius: var(--radius);
    box-shadow: 0 4px 12px rgba(0,255,20,0.4);
  }

  .links-uteis {
    margin-top: calc(var(--gap)*2);
  }

  .links-uteis h3 {
    color: var(--green);
    font-size: 1.2rem;
    margin-bottom: var(--gap);
    position: relative;
  }

  .links-uteis h3::after {
    content: '';
    position: absolute;
    left: 0;
    bottom: -4px;
    width: 40px;
    height: 2px;
    background: var(--green);
  }

  .links-uteis a {
    display: inline-block;
    margin: 6px 0;
    color: var(--green);
    text-decoration: none;
    font-weight: bold;
    transition: transform .2s;
  }

  .links-uteis a:hover {
    transform: translateX(4px);
  }

  .cards-area {
    margin-top: calc(var(--gap)*2);
  }

  #cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
    gap: var(--gap);
  }

  .card {
    background: var(--card-bg);
    border: 1px solid var(--green);
    border-radius: var(--radius);
    padding: var(--gap);
    backdrop-filter: blur(6px);
    transition: transform .2s, box-shadow .2s;
  }

  .card:hover {
    transform: translateY(-6px);
    box-shadow: 0 8px 20px rgba(0,255,20,0.4);
  }

  .card strong {
    color: var(--green);
    font-size: 1.1rem;
  }

  .card em {
    color: var(--text-muted);
    font-style: normal;
    margin-top: 4px;
  }

  #toggleCards {
    display: block;
    margin: var(--gap) auto 0;
    padding: 12px 24px;
    background: var(--green);
    color: #000;
    border: none;
    border-radius: var(--radius);
    font-weight: bold;
    cursor: pointer;
    transition: transform .2s, box-shadow .2s;
  }

  #toggleCards:hover {
    transform: scale(1.05);
    box-shadow: 0 0 12px var(--green);
  }

  footer {
    text-align: center;
    color: var(--text-muted);
    font-size: 0.8rem;
    margin: calc(var(--gap)*2) 0 0;
  }

  #filter {
    width: 100%;
    padding: 12px 16px;
    margin: var(--gap) 0;
    background: var(--bg2);
    color: var(--text-light);
    border: 1px solid var(--green);
    border-radius: var(--radius);
    font-size: 1rem;
    outline: none;
    transition: box-shadow .3s, background .3s;
  }

  #filter:hover,
  #filter:focus {
    background: rgba(0,0,0,0.6);
    box-shadow: 0 0 8px var(--green);
  }

  #loadingOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    visibility: hidden;
    opacity: 0;
    transition: opacity .3s ease;
    z-index: 9999;
  }

  #loadingOverlay.visible {
    visibility: visible;
    opacity: 1;
  }

  .spinner {
    width: 60px;
    height: 60px;
    border: 8px solid #333;
    border-top-color: var(--green);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .text {
    color: var(--green);
    font-weight: bold;
    margin-left: 12px;
  }
  </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<div id="loadingOverlay">
  <div class="spinner"></div><div class="text">Carregando…</div>
</div>
<div class="container">
  <div class="header">
    <img src="https://i.imgur.com/2tirOX5.png" alt="Logo" />
    <h1>Plantafix</h1>
    <p>Este site é um projeto de feira de ciências, no qual o usuário informa a doença ou sintoma que possui e o site retornará uma planta que pode curar ou tratar essa condição. Nossas fontes de pesquisa são da Wikipédia e PubMed.</p>
  </div>
  <div class="search-area">
    <input id="doenca" placeholder="Como podemos te ajudar hoje?" />
    <button id="buscar">Buscar</button>
  </div>
  <div id="resultado"></div>
  <div class="cards-area">
    <input id="filter" placeholder="Consulte o dicionário Plantafix!" />
    <div id="cards"></div>
    <button id="toggleCards">Mostrar mais</button>
  </div>
  <footer>Site criado por Matheus, Thalita e Heitor</footer>
</div>
<script>
const doencasEPlantas = {"Artrite":"Salix alba","Asma":"Eucalyptus globulus","Câncer":"Withania somnifera","Catarro":"Tussilago farfara","Diabetes":"Gymnema sylvestre","Insônia":"Valeriana officinalis","Dor de cabeça":"Mentha piperita","Hipertensão":"Allium sativum","Gripes":"Echinacea purpurea","Resfriado":"Echinacea purpurea","Dores musculares":"Arnica montana","Depressão":"Hypericum perforatum","Gastrite":"Zingiber officinale","Problemas digestivos":"Cuminum cyminum","Tensão nervosa":"Lavandula angustifolia","Úlcera gástrica":"Cichorium intybus","Cólica menstrual":"Angelica sinensis","Candidíase":"Cucumis sativus","Colesterol alto":"Panax ginseng","Dores de estômago":"Matricaria chamomilla","Dor de dente":"Syzygium aromaticum","Infecções urinárias":"Vaccinium macrocarpo","Problemas respiratórios":"Thymus vulgaris","Enxaqueca":"Tanacetum parthenium","Azia":"Cucumis melo","Queimaduras":"Aloe vera","Anemia":"Trifolium pratense","Infecção de garganta":"Salvia officinalis","Dores nas articulações":"Boswellia serrata","Bronquite":"Althaea officinalis","Eczema":"Calendula officinalis","Câncer de fígado":"Andrographis paniculata","Hemorroidas":"Hamamelis virginiana","Vermes intestinais":"Chenopodium ambrosioides","Diarreia":"Coptis chinensis","Constipação":"Rheum officinale","Cálculos renais":"Asparagus racemosus","Hipotireoidismo":"Coleus forskohlii","Pele seca":"Cocos nucifera","Infecção de ouvido":"Echinacea purpurea","Amigdalite":"Melissa officinalis","Hemorragias":"Achillea millefolium","Alzheimer":"Ginkgo biloba","Cálculos biliares":"Taraxacum officinale","Tontura":"Zingiber officinale","Náuseas":"Mentha spicata","Febre":"Tilia cordata","Hipoglicemia":"Momordica charantia","Fadiga":"Eleutherococcus senticosus","Infecção de pele":"Chamaecyparis obtusa","Tosse":"Cinnamomum verum","Queda de cabelo":"Trigonella foenum-graecum","Alergia":"Nicotiana tabacum","Desidratação":"Cucumis sativus","Úlcera péptica":"Myrtus communis","Cistos ovarianos":"Vitex agnus-castus","Pneumonia":"Eucalyptus citriodora","Aftas":"Sanguinaria canadensis","Rinite alérgica":"Allium cepa","Pedra nos rins":"Tribulus terrestris","Acne":"Azadirachta indica","Psoríase":"Vitis vinifera","Hepatite":"Silybum marianum","Alergias alimentares":"Bromelain","Varizes":"Ruscus aculeatus","Obesidade":"Camellia sinensis","Candidíase oral":"Cinnamomum zeylanicum","Anorexia":"Glycyrrhiza glabra","Gripe suína":"Eucalyptus globulus","Tensão alta":"Hibiscus sabdariffa","Dores nas costas":"Capsicum annuum","Cistite":"Orthosiphon aristatus","Infecções bacterianas":"Berberis vulgaris","Úlceras na boca":"Carya ovata","Gota":"Prunus cerasus","Anemia ferropriva":"Trigonella foenum-graecum","Vermes":"Cucurbita pepo","Câncer de mama":"Curcuma longa","Câncer de pulmão":"Crataegus monogyna","Espirros":"Urtica dioica","Rugas":"Hibiscus rosa-sinensis","Lúpus":"Corydalis yanhusuo","Hipotensão":"Panax ginseng","Estresse":"Passiflora incarnata","Sinusite":"Cinnamomum zeylanicum","Hemorroidas internas":"Aesculus hippocastanum","Malária":"Artemisia annua","Hipocalcemia":"Ostrea edulis","Síndrome do intestino irritável":"Mentha piperita","Cálculos vesiculares":"Chanca Piedra","Dor crônica":"Cannabis sativa","Náusea e vômito":"Cannabis sativa","Epilepsia":"Cannabis sativa","Ansiedade":"Cannabis sativa","PTSD":"Cannabis sativa","Glaucoma":"Cannabis sativa","Esclerose múltipla":"Cannabis sativa","Distúrbios do sono":"Cannabis sativa","Infecção por fungos":"Tabebuia impetiginosa","Infecção intestinal":"Psidium guajava","Fígado gorduroso":"Cynara scolymus","Baixa imunidade":"Uncaria tomentosa","Herpes labial":"Melissa officinalis","Tireoidite de Hashimoto":"Nigella sativa","Alergia de pele":"Avena sativa","Retenção de líquidos":"Taraxacum officinale","Refluxo ácido":"Foeniculum vulgare","Infecção por H. pylori":"Brassica oleracea","TPM":"Vitex agnus-castus","Infecção fúngica vaginal":"Melaleuca alternifolia","Coceira na pele":"Hamamelis virginiana","Feridas na pele":"Symphytum officinale","Mau hálito":"Petroselinum crispum","Baixa libido":"Lepidium meyenii","Memória fraca":"Bacopa monnieri","Dores de ouvido":"Allium sativum","Dermatite":"Aloe vera","Vaginose bacteriana":"Borago officinalis","Menopausa":"Glycine max","Cólicas intestinais":"Mentha × piperita","Estômago irritado":"Ulmus rubra","Zumbido no ouvido":"Ginkgo biloba","Inflamação crônica":"Curcuma longa","Problemas de próstata":"Serenoa repens","Infecção por Candida":"Origanum vulgare","Falta de apetite":"Gentiana lutea","Inflamação da bexiga":"Arctostaphylos uva-ursi","Oleosidade":"Melaleuca alternifolia","Manchas na pele":"Rosa rubiginosa","Feridas":"Symphytum officinale","Queimaduras solares":"Aloe vera","Coceiras":"Hamamelis virginiana","Pele envelhecida":"Hibiscus rosa-sinensis","Pele inflamada":"Arctium lappa","Irritação na pele":"Matricaria chamomilla","Flacidez facial":"Centella asiatica","Cicatrizes de acne":"Lactuca sativa"};

let geojsonEcoregions = null;
async function carregarGeoJSON() {
  const url = 'https://str44ng33.github.io/PlantaFix/data/wwf_terr_ecos_part1_split_4.geojson';
  const res = await fetch(url);
  const geojson = await res.json();
  geojsonEcoregions = geojson;
}
carregarGeoJSON();

function normalize(s) {
  return s.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
}

async function fetchSpecies(name) {
  const r = await fetch(`https://api.gbif.org/v1/species/match?name=${encodeURIComponent(name)}`);
  const j = await r.json();
  return j.usageKey ? [{name:j.canonicalName,status:j.status}] : [];
}

function tryWiki(lang) {
  return async name => {
    const res = await fetch(`https://${lang}.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(name)}&prop=extracts&exintro=true&explaintext=true&format=json&origin=*`);
    const j = await res.json();
    const p = j.query.pages[Object.keys(j.query.pages)[0]];
    if(!p.extract) throw '';
    return p.extract;
  }; 
}

async function fetchDescription(name) {
  for(const fn of [tryWiki('pt'), tryWiki('es'), tryWiki('en')]) {
    try { const txt = await fn(name); if(txt) return txt; } catch {}
  }
  return 'Descrição não disponível.';
}

async function translateText(text) {
  const r = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=pt&dt=t&q=${encodeURIComponent(text)}`);
  const j = await r.json();
  return j[0].map(p=>p[0]).join('');
}

async function fetchPubMed(term) {
  const s = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(term)}&retmax=1&retmode=json`);
  const sj = await s.json(); const id = sj.esearchresult.idlist[0];
  if(!id) return null;
  const e = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${id}&retmode=json`);
  const ej = await e.json(); const doc = ej.result[id];
  const title = doc.title, author = doc.authors?.[0]?.name||'Autor desconhecido', link = `https://pubmed.ncbi.nlm.nih.gov/${id}/`;
  const titlePt = await translateText(title), authorPt = await translateText(author);
  return {title,author,titlePt,authorPt,link};
}

async function detectarEcoregion(planta) {
  if(!geojsonEcoregions) await carregarGeoJSON();
  const resp = await fetch(`https://api.gbif.org/v1/occurrence/search?scientificName=${encodeURIComponent(planta)}&limit=20`);
  const data = await resp.json();
  const pontos = data.results.filter(r=>r.decimalLatitude&&r.decimalLongitude).map(r=>turf.point([r.decimalLongitude,r.decimalLatitude]));
  if(!pontos.length) return 'Sem dados de ocorrência';
  for(const ponto of pontos) {
    for(const feat of geojsonEcoregions.features) {
      if(turf.booleanPointInPolygon(ponto,feat)) {
        return feat.properties.ECO_NAME||feat.properties.BIOME||'Bioma desconhecido';
      }
    }
  }
  return 'Bioma não identificado';
}

async function traduzirBioma(bioma) {
  const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=pt&dt=t&q=${encodeURIComponent(bioma)}`);
  const data = await res.json();
  return data[0][0][0];
}
async function searchWikiPage(term) {
  const url = `https://pt.wikipedia.org/w/api.php?` +
    `action=query&list=search&srsearch=${encodeURIComponent(term)}` +
    `&format=json&origin=*`;
  const res = await fetch(url);
  const j = await res.json();
  const first = j.query.search[0];
  return first ? first.title : null;
}

async function fetchBiomeSummaryAndImage(biomeTitle) {
  if (!biomeTitle) return { extract: 'Resumo não disponível.', thumbnail: null };
  const url = `https://pt.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(biomeTitle)}`;
  const res = await fetch(url);
  if (!res.ok) return { extract: 'Resumo não disponível.', thumbnail: null };
  const json = await res.json();
  return {
    extract: json.extract || 'Resumo não disponível.',
    thumbnail: json.thumbnail?.source || null
  };
}


let showAll = false;
function renderCards(filter='') {
  const c = document.getElementById('cards'); c.innerHTML = '';
  const f = normalize(filter);
  let items = Object.entries(doencasEPlantas).filter(([d,p])=>normalize(d).includes(f)||normalize(p).includes(f));
  items = showAll?items:items.slice(0,18);
  for(const [d,p] of items) {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<strong>${d}</strong><br/><em>${p}</em>`;
    c.appendChild(card);
  }
}
document.getElementById('filter').addEventListener('input', e=>renderCards(e.target.value));
document.getElementById('toggleCards').addEventListener('click', ()=>{
  showAll = !showAll;
  document.getElementById('toggleCards').textContent = showAll?'Mostrar menos':'Mostrar mais';
  renderCards(document.getElementById('filter').value);
});
renderCards();

const overlay = document.getElementById('loadingOverlay');
const showLoading = ()=>overlay.classList.add('visible');
const hideLoading = ()=>overlay.classList.remove('visible');

document.getElementById('buscar').addEventListener('click', async ()=>{
  showLoading();
  const inp = document.getElementById('doenca').value.trim();
  const key = Object.keys(doencasEPlantas).find(k=>normalize(k)===normalize(inp));
  const planta = key? doencasEPlantas[key] : null;
  const out = document.getElementById('resultado');
  out.innerHTML = '';
  if(!planta) {
    hideLoading();
    out.textContent = 'Não encontramos uma planta pra isso.';
    return;
  }
  const [sp, desc, pm] = await Promise.all([fetchSpecies(planta), fetchDescription(planta), fetchPubMed(planta)]);
  const descPt = await translateText(desc);
  let imgUrl = null;
  if(sp.length) {
    const w = await fetch(`https://pt.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(sp[0].name)}`);
    const wj = await w.json();
    imgUrl = wj.thumbnail?.source || null;
  }
  out.innerHTML = `
    <p>Planta recomendada pra <strong>${key}</strong>: <em>${planta}</em></p>
    <div class="species-block">
      <div>
        <h3 style="color:var(--green)">Espécie encontrada</h3>
        <ul>${sp.map(s=>`<li><strong>${s.name}</strong> (${s.status})</li>`).join('')}</ul>
      </div>
      ${imgUrl?`<img src="${imgUrl}" style="width:180px;height:120px;border-radius:var(--radius);object-fit:cover">`:``}
    </div>
    <h3 style="color:var(--green);margin-top:20px">Descrição</h3>
    <p>${descPt}</p>
  `;
  const eco = await detectarEcoregion(sp[0].name);
  const ecoPt = await traduzirBioma(eco);

  let biomaImg = null;
  const trySummary = async (lang, title) => {
    const slug = title.replace(/\s+/g, '_');
    const res = await fetch(
      `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(slug)}`
    );
    if (!res.ok) throw new Error(`no_${lang}`);
    const json = await res.json();
    return json.thumbnail?.source || null;
  };

  try {
    biomaImg = await trySummary('pt', ecoPt);
  } catch {
    try {
      biomaImg = await trySummary('en', eco);  
    } catch {
      biomaImg = null;
    }
  }

  out.innerHTML += `
    <div style="display:flex;align-items:center;gap:16px;margin-top:16px">
      ${biomaImg
        ? `<img src="${biomaImg}" style="
             width:120px;
             height:80px;
             border-radius:8px;
             object-fit:cover;
             box-shadow:0 4px 8px rgba(0,255,20,0.4);
           " alt="${ecoPt}" />`
        : ``}
      <p style="color:var(--green);margin:0;font-weight:bold">
        Bioma detectado: ${ecoPt}
      </p>
    </div>
  `;
  out.innerHTML += `
    <div style="margin-top:30px">
      <h3 style="color:var(--green)">Links Úteis</h3>
      <a href="https://www.google.com/maps/search/plantas+perto+de+mim" target="_blank" style="display:block;color:var(--green);text-decoration:underline;margin:6px 0">
        Lugares perto de mim pra adquirir plantas
      </a>
      <a href="https://www.youtube.com/results?search_query=como+cultivar+${encodeURIComponent(planta)}" target="_blank" style="display:block;color:var(--green);text-decoration:underline;margin:6px 0">
        Como cultivar ${planta}
      </a>
    </div>
  `;
  hideLoading();
});
</script>
</body>
</html>
